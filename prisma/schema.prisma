generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String            @id @default(cuid())
  email                 String            @unique
  name                  String
  lastName              String?
  username              String?           @unique
  dateOfBirth           DateTime?
  hashedPassword        String
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  role                  String            @default("user")
  profilePictureUrl     String?
  needsPasswordChange   Boolean           @default(false)
  isActive              Boolean           @default(false) // User must be activated by admin
  bets                  Bet[]
  competitionsLastPlace Competition[]     @relation("CompetitionLastPlace")
  competitionsWon       Competition[]     @relation("CompetitionWinner")
  competitions          CompetitionUser[]
  stats                 UserStats?
}

model UserStats {
  id               String   @id @default(cuid())
  userId           String   @unique
  totalPredictions Int      @default(0)
  totalPoints      Int      @default(0)
  accuracy         Float    @default(0)
  wins             Int      @default(0)
  longestStreak    Int      @default(0)
  exactScoreStreak Int      @default(0)
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id])
}

model Competition {
  id            String            @id @default(cuid())
  name          String
  description   String
  startDate     DateTime
  endDate       DateTime
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  status        String            @default("upcoming")
  lastPlaceId   String?
  logo          String?
  winnerId      String?
  sportType     SportType         @default(FOOTBALL) // Sport type: FOOTBALL or RUGBY
  externalSeason String?          // For Rugby: cached season partition key (e.g., "2024" for 2024/25 season)
  lastPlace     User?             @relation("CompetitionLastPlace", fields: [lastPlaceId], references: [id])
  winner        User?             @relation("CompetitionWinner", fields: [winnerId], references: [id])
  users         CompetitionUser[]
  games         Game[]
  news          News[]
}

model CompetitionUser {
  id                String      @id @default(cuid())
  userId            String
  competitionId     String
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  shooters          Int         @default(0)
  finalWinnerTeamId String?     // User's prediction for the final winner (Champions League only)
  competition       Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  finalWinnerTeam   Team?       @relation("FinalWinnerPrediction", fields: [finalWinnerTeamId], references: [id], onDelete: SetNull)

  @@unique([competitionId, userId])
}

model Team {
  id                    String            @id @default(cuid())
  name                  String
  shortName             String?
  logo                  String?
  country               String?           // Country code or name (e.g., "France", "England")
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  category              TeamCategory      @default(NATIONAL)
  sportType             SportType?        // Optional: Can be null if team plays multiple sports or sport is unknown
  awayGames              Game[]            @relation("AwayTeam")
  homeGames              Game[]            @relation("HomeTeam")
  finalWinnerPredictions CompetitionUser[] @relation("FinalWinnerPrediction")

  @@unique([name, sportType]) // Allow same name for different sports
}

model Game {
  id             String      @id @default(cuid())
  competitionId  String
  date           DateTime
  status         GameStatus  @default(UPCOMING)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  awayScore      Int?
  awayTeamId     String
  homeScore      Int?
  homeTeamId     String
  matchday       Int?
  // Live score fields for external API integration
  externalId     String? // Football-Data.org game ID
  liveHomeScore  Int? // Live home score from external API
  liveAwayScore  Int? // Live away score from external API
  lastSyncAt     DateTime? // Last time we synced with external API
  externalStatus String? // External API status (IN_PLAY, FINISHED, etc.)
  statusDetail   String? // Status detail (HT, AET, PEN, PPD, SUS, etc.)
  decidedBy      String? // How the game was decided (FT, AET, PEN)
  finishedAt     DateTime? // When the game was first marked as finished
  elapsedMinute  Int? // Current minute of the match (0-90+) - V2 feature
  bets           Bet[]
  awayTeam       Team        @relation("AwayTeam", fields: [awayTeamId], references: [id])
  competition    Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  homeTeam       Team        @relation("HomeTeam", fields: [homeTeamId], references: [id])
}

model Bet {
  id        String   @id @default(cuid())
  userId    String
  gameId    String
  points    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  score1    Int
  score2    Int
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId])
}

model News {
  id            String      @id @default(cuid())
  competitionId String
  matchDayDate  DateTime    // The date of the match day this news covers
  summary       String      // The AI-generated summary text
  logo          String?     // Competition logo URL
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)

  @@unique([competitionId, matchDayDate]) // One news item per competition per match day
  @@index([competitionId, matchDayDate])   // For efficient queries
}

enum UserRole {
  USER
  ADMIN
}

enum CompetitionStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum GameStatus {
  UPCOMING
  LIVE
  FINISHED
  CANCELLED
  RESCHEDULED
}

enum BetStatus {
  PENDING
  WON
  LOST
  CANCELLED
}

enum TeamCategory {
  NATIONAL
  CLUB
}

enum SportType {
  FOOTBALL
  RUGBY
}
